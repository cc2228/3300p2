<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
<!-- Stylesheets -->
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/d3.slider.css" />

<!-- Fonts -->
<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<head>

<!-- TODO
Update tooltips
Update when clicking to different 
 -->

<body>

  <h2>World Energy Measurements</h2>
  <div id ="buttons">
    <button id="toggleCons">Energy Consumption</button> <button id="toggleProd">Energy Production</button>
  </div>

  <input id="slider2" class = "slider" type="range" min="1993" max="2013" value = "1993" step="1" /><br>
  <div id = "sliderAxis">
    <div class = "yearAxis" id = "tick1">1993</div><div class = "yearAxis" id = "tick2">2003</div><div class = "yearAxis" id = "tick3">2013</diV>
  </div>
  <div id = "rightSideTitle">
    Top 3 countries vs. 3 user selected countries

  </div>
  <div id="tooltip-container"></div>

  <div id = "viz">
    <div id="canvas-svg">
      <div id = "sliderNum">1993</div>
    </div>

    <div id="dataZoom"></div>
    <div id="chordG"></div>

  </div>

    <button id = "play">Play</button>

<script>
$(document).bind('scroll', function() {
   if ($(this).scrollTop() > 100) {
      $("#buttons").addClass("fixed");
      $(".slider").addClass("fixedSlider");
      $(".yearAxis").addClass("fixedYearAxis");
   }
   else {
      $("#buttons").removeClass("fixed");     
      $(".slider").removeClass("fixedSlider"); 
      $(".yearAxis").removeClass("fixedYearAxis");
   }
});
//slider

// Color scale
var getColor = d3.scale.linear().domain([0,100]).range(["#d6f5d6","#145214"]);
var valueHash, quantize, countries;

var countriesSelected = new Array();
var sliderD = "China";
var makeTransitionOnBars = true;


function ToggleMap(file, input) {

  d3.csv(file, function(err, data) {

    var config = {"country":"Country", "score":input};

    var width = 720, height = 1000;

    var country_key = config.country;
    var score_value = config.score;

    // d3 projection of world map
    var projection = d3.geo.mercator().scale((width + 1) / 2 / Math.PI).translate([width / 2, height / 2]).precision(.1);

    var path = d3.geo.path().projection(projection);

    var graticule = d3.geo.graticule();

    var svg = d3.select("#canvas-svg").append("svg")
      .attr("width", width)
      .attr("height", height);

    svg.append("path").datum(graticule).attr("class", "graticule").attr("d", path);

      // Create hashmap with country and value
    valueHash = {};
    data.forEach(function(d) {
      valueHash[d[country_key]] = +d[score_value];
    });



    // hashmap for population data
    var popHash = {};

    // Import data for population, create hash value that can later be used to compare with consumption/prod
    d3.csv("population.csv", function(err, popData) {
      // Lillyan: Can you make the slider work for this part too? This is the population
      var configPop = {"country":"Country", "score": "1993"};

      var country_key_pop = configPop.country;
      var score_value_pop = configPop.score;
      popData.forEach(function(d) {
          popHash[d[country_key_pop]] = +d[score_value_pop];
      });

      quantize = d3.scale.quantize().domain([0, 1.0]).range(d3.range(100).map(function(i) { return i; }));

      quantize.domain([d3.min(data, function(d){
        return (+d[score_value]) }),
      d3.max(data, function(d){
        return (+d[score_value]) })]);

      // Source: Vida world json file
      d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/world-topo-min.json", function(error, world) {
        countries = topojson.feature(world, world.objects.countries).features;

        //initialize bar graph
        sliderD = countries[41];
        draw(sliderD, valueHash);
        svg.append("path")
           .datum(graticule)
           .attr("class", "choropleth")
           .attr("d", path);

        var g = svg.append("g");

        g.append("path")
         .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
         .attr("class", "equator")
         .attr("d", path);

        var country = g.selectAll(".country").data(countries);

        ////------------------------------------------------------------------
        country.enter().insert("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("id", function(d,i) { return d.id; })
        .attr("title", function(d) { return d.properties.name; })
        .style("fill", function(d) {
          if (valueHash[d.properties.name]) {
              var c = quantize((valueHash[d.properties.name]));
              return getColor(c);
          } else {
              return "#ccc";
          }
        })

        // Dynamic part: mouseover to see country name and energy info
        .on("mousemove", function(d) {
          var html = "";

          html += "<div class=\"tooltip_kv\">";
          html += "<span class=\"tooltip_key\">";
          html += d.properties.name;
          html += "</span>";
          html += "<span class=\"tooltip_value\">";
          html += (valueHash[d.properties.name] ? valueHash[d.properties.name] : "");
          html += "";
          html += "</span>";
          html += "</div>";
          
          $("#tooltip-container").html(html);
          $(this).attr("fill-opacity", "0.8");
          $("#tooltip-container").show();
          
          var coordinates = d3.mouse(this);
          
          var map_width = $('.choropleth')[0].getBoundingClientRect().width;
          
          if (d3.event.pageX < map_width / 2) {
            d3.select("#tooltip-container")
              .style("top", (d3.event.layerY +250) + "px")
              .style("left", (d3.event.layerX) + "px");
          } else {
            var tooltip_width = $("#tooltip-container").width();
            d3.select("#tooltip-container")
              .style("top", (d3.event.layerY +250) + "px")
              .style("left", (d3.event.layerX - tooltip_width - 30) + "px");
          }
        })

        .on("click", function(d) {

          if(countriesSelected.length < 3) {
            countriesSelected.push(d);
          }
          else {
            countriesSelected[2] = countriesSelected[1];
            countriesSelected[1] = countriesSelected[0];
            countriesSelected[0] = d;
          }

          sliderD = draw(d, valueHash);

        })

        .on("mouseout", function() {
          $(this).attr("fill-opacity", "1.0");
          $("#tooltip-container").hide();
        }); //end of country line
          
        g.append("path")
            .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
            .attr("class", "boundary")
            .attr("d", path);
        
        svg.attr("height", height * 2.2 / 3);

      }); //end of json map function
        //-----------------------------------------------------------------
      function draw(objj, values) {

        d3.select("#dataZoom").remove();

        //recreate bar graph
        d3.select("#viz").append("svg").attr("id", "dataZoom").attr("width", "440").attr("height","320");
        var dataZoom = d3.select("#dataZoom");

        var dataZoomXScale = d3.scale.linear().domain([0,120]).range([0,440]);
        var xAxis = d3.svg.axis().scale(dataZoomXScale).orient("bottom").ticks(6);
        dataZoom.append("g").attr("class", "axis").attr("transform", "translate(0, 300)").call(xAxis);

        var topThree = getTopThree(values);

        var rectHeight = 30;
        var transitionDuration = 750;

        for(var i = 0; i < 3; i++) {

          var barWidth = topThree[i]["value"];
          var barTitle = topThree[i]["countryName"];
          
          if(makeTransitionOnBars) {
            dataZoom.append("rect")
            .attr("x", "10")
            .attr("y", i*40+10)
            .attr("height", rectHeight)
            .attr("width", 0)
            .transition(transitionDuration)
            .attr("width", dataZoomXScale(barWidth));
          }
          else {
            dataZoom.append("rect")
            .attr("x", "10")
            .attr("y", i*40+10)
            .attr("height", rectHeight)
            .attr("width", dataZoomXScale(barWidth));
          }
          dataZoom.append("text").attr("x","20").attr("y", i*40+30).attr("fill", "#fff").text(barTitle);

        }

        for (var x = 0; x < countriesSelected.length; x++) {
          console.log("hit");
          dataZoom.append("rect")
          .attr("x", "10")
          .attr("y", x*40+170)
          .attr("height", rectHeight)
          .attr("width", 0)
          .transition(transitionDuration)
          .attr("width", dataZoomXScale(values[countriesSelected[x].properties.name]));

          dataZoom.append("text").attr("x","20").attr("y", x*40+190).attr("fill", "#fff").text(countriesSelected[x].properties.name);         
        }
        

        // Energy consumed (in million btu) per person
        var popValue = values[objj.properties.name]/popHash[objj.properties.name] * 1000;
        dataZoom.append("text").attr("x","20").attr("y","350")
          .attr("fill", "#00000")
          .attr("font-size", "20px")
          .text("Every person in " + objj.properties.name + " spends/consumes " + Math.round(popValue) + " million btu of energy");

        return objj;

      }

      d3.select(self.frameElement).style("height", (height * 2.3 / 3) + "px");
      /***********************
      * Slider
      ***********************/

      d3.select("#slider2").on("input", function() {
          var rval = (this).value;
          $("#sliderNum").html(rval);
         if ($('#toggleCons').hasClass("active")) {
            refillMap("consumption.csv", ""+rval, sliderD);
          }
          else if ($('#toggleProd').hasClass("active")) {
            refillMap("production.csv", ""+rval, sliderD);
            loadChords(rval);
          }          
      });


      function refillMap(file, input, clickedCountry) {
        var map = d3.select("#canvas-svg");
        d3.csv(file, function(err, data) {
          var config = {"country":"Country", "score":input};
          var country_key = config.country;
          var score_value = config.score;
          valueHash = {};
            data.forEach(function(d) {
            valueHash[d[country_key]] = +d[score_value];
          });

          if(makeTransitionOnBars) draw(clickedCountry, valueHash);


          map.selectAll(".country").data(countries)
            .transition(750)
            .style("fill", function(d) {
            if (valueHash[d.properties.name]) {
              var c = quantize((valueHash[d.properties.name]));
                // console.log(getColor(c));
              return getColor(c);
                // return "#ccc";
            } else {
                    return "#ccc";
            }
          });

        }); 
      } //end of refill


      $("#play").click(function() {
         //if value < max

        $("#slider2").val(1993);  
        $("#slider2").trigger('change');

        var i = 0, howManyTimes = 21;
        function f() {

            makeTransitionOnBars = false    

            $("#slider2").val(1993+i);  
            $("#slider2").trigger('change');
            rval = $("#slider2").val();
            $("#sliderNum").html(rval);

            console.log(rval);

            if ($('#toggleCons').hasClass("active")) {
              refillMap("consumption.csv", ""+rval, sliderD);
            }
            else if ($('#toggleProd').hasClass("active")) {
              refillMap("production.csv", ""+rval, sliderD);
              loadChords(rval);
            } 

            i++;
            if( i < howManyTimes ){
                setTimeout( f, 500 );
            }
            else {
              makeTransitionOnBars = true;  
            }
        }
        f();
      });
    }); //end of population csv

  }); //end of countries csv

} //end of toggle map

// Default on Consumption
var innerDiv = document.createElement('div');
innerDiv.id = 'sliderNum';
innerDiv.innerHTML = $("#slider2").val();

// The variable iDiv is still good... Just append to it.


ToggleMap("consumption.csv", "1993");
document.getElementById('toggleCons').style.fontWeight = "bold";
$("#toggleCons").addClass("active");

// Toggles between the multiple graphs
$("#toggleCons").on('click', function() {
  //document.getElementById('toggleEPI').style.fontWeight = "normal";
  document.getElementById('toggleProd').style.fontWeight = "normal";
  $("#canvas-svg").empty(); 
  document.getElementById("canvas-svg").appendChild(innerDiv);

  $(this).siblings().removeClass('active');
  $(this).addClass('active');

  document.getElementById('toggleCons').style.fontWeight = "bold";
  ToggleMap("consumption.csv", "1993");
});


$("#toggleProd").on('click', function() {
  //document.getElementById('toggleEPI').style.fontWeight = "normal";
  document.getElementById('toggleCons').style.fontWeight = "normal";
  $("#canvas-svg").empty(); 
  document.getElementById("canvas-svg").appendChild(innerDiv);

  $(this).siblings().removeClass('active');
  $(this).addClass('active');

  document.getElementById('toggleProd').style.fontWeight = "bold";
  ToggleMap("production.csv", "1993");
});


//Sort the values so that we can display the top three
function sortobj(obj) {
  var keys=Object.keys(obj);
  var kva= keys.map(function(k,i) {
      return [k,obj[k]];
  });
  kva.sort(function(a,b){
      if(a[1]>b[1]) return -1;if(a[1]<b[1]) return 1;
      return 0
  });
  var o={}
  kva.forEach(function(a){ o[a[0]]=a[1]})
  return o;
}

  //get the top three co
function getTopThree(arrayToSort) {

  arrayToSort = sortobj(arrayToSort); 
  var x = 0;
  var topThree = [];
  for (var countryName in arrayToSort) {
    if(x < 3) {
      var countryToPush = {};
      countryToPush.countryName = countryName;
      countryToPush.value = arrayToSort[countryName];
      topThree.push(countryToPush);

    }
     x++;
  }
  return topThree;

}
/***********************
* Chord Graph
***********************/
// var cmargin = {left: 50, top: 10, right: 50, bottom: 10};
var cwidth = 410;
var cheight = 333; // 5/6

var csvg = d3.select('#chordG').append('svg')
  .attr("width", cwidth)
  .attr("height", cheight) // does not rely on margins

var outerRadius = cheight / 2 - 100;
var innerRadius = outerRadius * 0.95;
var opacityDef = 0.7;

var labels = ["Coal", "Electricity", "Natural Gas","Petroleum", "", "China", "USA", "Russia", "Other", ""];

var wrapper = csvg.append("g").attr("class", "chordWrapper")
  .attr("transform", "translate(" + (cwidth / 2 ) + "," + (cheight / 2 ) + ") scale(2.0)" );


// d3.text("Production/1993.csv", "text/csv", function(err,data) {
var offset;
d3.text("Production/2013.csv", "text/csv", function(err,data) { 
  matrix = d3.csv.parseRows(data);
  for (var i = 0; i < matrix.length; i++) {
    for (var j = 0; j < matrix.length; j++) {
      matrix[i][j] = parseInt(matrix[i][j]);
    }
  }
  var emptyStroke = parseInt(matrix[9][4]);

  // Rotation for vertical invisible chord
  offset = Math.PI * (emptyStroke/(emptyStroke / .4)) / 2;

  var chord = d3.layout.chord()
    .padding(.02)
    .sortSubgroups(d3.descending)
    .sortChords(d3.descending)
    .matrix(matrix)

  var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(outerRadius)
    .startAngle(startAngle)
    .endAngle(endAngle);

  var path = d3.svg.chord()
    .radius(innerRadius)
    .startAngle(startAngle)
    .endAngle(endAngle);

  var fill = d3.scale.ordinal()
    .domain(d3.range(labels.length))
    .range(["#C4C4C4","#C4C4C4","#C4C4C4", "#C4C4C4","#E0E0E0","#EDC951","#CC333F","#00A0B0", "#7D1D3F", "#E0E0E0"]) //change later

  /* Outer Arcs */ 
  var g = wrapper.selectAll("g.group")
    .data(chord.groups)
    .enter().append("g")
    .attr("class", "group");
  g.append("path")
    .style("stroke", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
    .style("fill", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
    .attr("d", arc)
    .on("mouseover", fade(.1))
    .on("mouseout", fade(.7));


  /* Append Names */ 
  g.append("text")
      .each(function(d) { d.angle = ((d.startAngle + d.endAngle) / 2) + offset;}) //Slightly altered function to define the angle
      .attr("dy", "0em")
      .attr("class", "titles")
      .attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
      .attr("transform", function(d,i) { 
        var c = arc.centroid(d);
        return "rotate(" + (d.angle * 180 / Math.PI - 100) + ")"
        + "translate(" + (innerRadius + 10) + ")"
        + (d.angle > Math.PI ? "rotate(180)" : "")
      })
      .text(function(d,i) { return labels[i]; });

  /* Inner Chords */ 
  var chords = wrapper.selectAll("path.chord")
    .data(chord.chords)
    .enter().append("path")
    .attr("class", "chord")
    .style("stroke", "none")
    .style("fill", function(d,i) { 
      return fill(d.target.index); 
    })
    .style("opacity", function(d) {
      if (labels[d.source.index] === "") return 0;
      else return opacityDef;
    })
    .attr("d", path);

  })

function startAngle(d) { return d.startAngle + .7 * offset; }
function endAngle(d) { return d.endAngle + .7 * offset; }
function fade(opac) {
  return function(g, i) { // i is the specific cord/source
    csvg.selectAll("path.chord")
      .filter(function(d) {
        return d.source.index != i && d.target.index != i; 
      })
      .transition(750)
        .style("opacity", function(d) {
          if (labels[d.source.index] === "") return 0;
          else return opac;
        })
  }
}

function loadChords(input) {
  var chord = d3.select("#chordG");
  var matrix;
  // Get array of arrays- all values are STRINGS
  console.log("Production/" + String(input) + ".csv");
  d3.text("Production/" + String(input) + ".csv", "text/csv", function(err,data) {  
    console.log(data);
    matrix = d3.csv.parseRows(data);
      // d.map(function(e) {
      //  e = +e;
      // }) //returns empty matrix
    // });
    // Convert from string to int
    for (var i = 0; i < matrix.length; i++) {
      for (var j = 0; j < matrix.length; j++) {
        matrix[i][j] = parseInt(matrix[i][j]);
      }
    }
    var emptyStroke = matrix[9][4];

    // Rotation for vertical invisible chord
    var offset = Math.PI * (emptyStroke/(emptyStroke / .4)) / 2;

    chord = d3.layout.chord()
      .padding(.02)
      .sortSubgroups(d3.descending)
      .sortChords(d3.descending)
      .matrix(matrix)

    arc = d3.svg.arc()
      .innerRadius(innerRadius)
      .outerRadius(outerRadius)
      .startAngle(startAngle)
      .endAngle(endAngle);

    path = d3.svg.chord()
      .radius(innerRadius)
      .startAngle(startAngle)
      .endAngle(endAngle);
    var fill = d3.scale.ordinal()
      .domain(d3.range(labels.length))
      .range(["#C4C4C4","#C4C4C4","#C4C4C4", "#C4C4C4","#E0E0E0","#EDC951","#CC333F","#00A0B0", "#7D1D3F", "#E0E0E0"]) //change later

    /* Outer Arcs */ 
    g = wrapper.selectAll("g.group")
      .data(chord.groups);
      // .attr("class", "group");
    g.select("path")
      .style("stroke", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
      .style("fill", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
      .attr("d", arc)
      .on("mouseover", fade(.1))
      .on("mouseout", fade(.7));
    /* Append Names */ 

    /* Inner Chords */ 
    chords = wrapper.selectAll("path.chord")
      .data(chord.chords)
      // .attr("class", "chord")
      .style("stroke", "none")
      .style("fill", function(d,i) { 
        return fill(d.target.index);
      })
      .style("opacity", function(d) {
      if (labels[d.source.index] === "") return 0;
      else return opacityDef;
    })
      .attr("d", path);
  })
}


</script>

</body>
</html>