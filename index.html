<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
<!-- Stylesheets -->
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/d3.slider.css" />

<!-- Fonts -->
<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src = "js/vivus.js"></script>
<!-- D3 Legends -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/1.10.0/d3-legend.js"></script>
<script src = "js/fisheye.js"></script>
<head>

<!-- TODO
Update tooltips
Update when clicking to different 
 -->

<body>

  <h2>Dominating Countries in Energy Consumption</h2>
<!--   <div id = "jumpPreventOnFixed" style = "height:100px;">
 -->    
<!--     </div>
 -->

  <div id = "rightSideTitle">
    Consumption vs. Production Country Comparison<br><br>
  </div>
  <div id="tooltip-container"></div>

  <div id = "viz">
    <div id="canvas-svg">
      <div id = "sliderNum">1993</div>
    </div>
    <div id="dropdowns">
      Click a country on the map or select:
      <select id="country3"></select><!-- 
      <select id="country2"></select>
      <select id="country"></select> -->
    </div>


<!--     <button type id="button">Compare Countries</button><br>
 -->
    <div id="dataZoom"></div>

  </div>

    <div id = "rightSideTitle">
      Energy Breakdown of the Top 3 Countries
    </div>
    <div id = "rightSide">
      <div id="dataZoom"></div>

      <div id="chordG"></div>
    </div>


    <div id = "sliderAxis">
      <img id="play" src="http://makercon.com/wp-content/themes/makercon/img/play-btn.png">
      <input id="slider2" class = "slider" type="range" min="1993" max="2013" value = "1993" step="1" /><br>
      <div class = "yearAxis" id = "tick1">1993</div>
      <div class = "yearAxis" id = "tick2">2003</div>
      <div class = "yearAxis" id = "tick3">2013</diV>
    </div>
    </div>

    <div id="bottomText">
      <p>Hello test test test test ello test test test test ello test test test test </p>
      <p>We can write a description to fill up the space here!</p>
    </div>


<!--     <div id ="buttons">
 --> 



<script>
/*
$(document).bind('scroll', function() {
   if ($(this).scrollTop() > 150) {
      $("#buttons").addClass("fixed");
      $(".slider").addClass("fixedSlider");
      $(".yearAxis").addClass("fixedYearAxis");
   }
   else {
      $("#buttons").removeClass("fixed");     
      $(".slider").removeClass("fixedSlider"); 
      $(".yearAxis").removeClass("fixedYearAxis");
   }
});*/
//slider

// Color scale
var getColor = d3.scale.linear().domain([0,120]).range(["#d6f5d6","#005689"]);
var valueHash, quantize, countries, productionValueHash;


var countriesSelected = new Array();
var sliderD = "China";
var allowBarGraphToChange = true;
var fisheye = d3.fisheye.circular()
    .radius(200)
    .distortion(2);

// input argument should be the year as a string
function ToggleMap(file, input) {

  d3.csv(file, function(err, data) {

    // Creating hash map for production for all countries for specfic year (specified by input)
    d3.csv('production.csv', function(err, producData) {
      console.log(input);
      var configProd = {"country":"Country", "score":input};

      var country_key = configProd.country;
      var score_value = configProd.score;

      productionValueHash = {};
      producData.forEach(function(d) {
        productionValueHash[d[country_key]] = +d[score_value];
      });


      var config = {"country":"Country", "score":input};

      var width = 720, height = 720;

      var country_key = config.country;
      var score_value = config.score;

      // d3 projection of world map
      var projection = d3.geo.mercator().scale((width + 1) / 2 / Math.PI)
      .translate([width / 2, height / 2])
      .precision(.1);

      var path = d3.geo.path().projection(projection);

      var graticule = d3.geo.graticule();

      var svg = d3.select("#canvas-svg").append("svg")
        .attr("width", width)
        .attr("height", height);

      svg.append("path").datum(graticule).attr("class", "graticule").attr("d", path);

        // Create hashmap with country and value
      valueHash = {};
      data.forEach(function(d) {
        valueHash[d[country_key]] = +d[score_value];
      });



      // hashmap for population data
      var popHash = {};

      // Import data for population, create hash value that can later be used to compare with consumption/prod
      d3.csv("population.csv", function(err, popData) {
        // Lillyan: Can you make the slider work for this part too? This is the population
        var configPop = {"country":"Country", "score": "1993"};

        var country_key_pop = configPop.country;
        var score_value_pop = configPop.score;
        popData.forEach(function(d) {
            popHash[d[country_key_pop]] = +d[score_value_pop];
        });

        quantize = d3.scale.quantize().domain([0, 1.0]).range(d3.range(100).map(function(i) { return i; }));

        quantize.domain([d3.min(data, function(d){
          return (+d[score_value]) }),
        d3.max(data, function(d){
          return (+d[score_value]) })]);

        // Source: Vida world json file
        d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/world-topo-min.json", function(error, world) {
          countries = topojson.feature(world, world.objects.countries).features;


          // Drop-down menu: to select three countries
          var options = ""
          for (var i=0; i<countries.length; i++) {
            options += "<option value=" + countries[i].id + '>' + countries[i].properties.name + "</option>";
          }
          document.getElementById("country3").innerHTML = options;/*
          document.getElementById("country2").innerHTML = options;
          document.getElementById("country").innerHTML = options;*/

          var firstCountry, secondCountry, thirdCountry;

          // submit button for drop down countries
          d3.select("#country3").on('change', function(d) { 
            firstCountry = document.getElementById("country3").value;/*
            secondCountry = document.getElementById("country2").value;
            thirdCountry = document.getElementById("country").value;*/

            var buttonCountries = [firstCountry];

            for (var i =0; i<buttonCountries.length; i++) { 
              d3.selectAll('path').filter(function(d) {
                if (d.id == buttonCountries[i]) {
                    if(countriesSelected.length < 3) {
                      countriesSelected.push(d);
                    }
                    else {
                      countriesSelected[2] = countriesSelected[1];
                      countriesSelected[1] = countriesSelected[0];
                      countriesSelected[0] = d;
                    }
                    console.log(countriesSelected);
                    draw(d, valueHash, productionValueHash);
                }
              })
            }
          }) // end button for country drop down

          //initialize bar graph
          sliderD = countries[41];
          draw(sliderD, valueHash, productionValueHash);
          svg.append("path")
             .datum(graticule)
             .attr("class", "choropleth")
             .attr("d", path);

          var g = svg.append("g");

          g.append("path")
           .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
           .attr("class", "equator")
           .attr("d", path);

          var country = g.selectAll(".country").data(countries);

          ////------------------------------------------------------------------
          country.enter().insert("path")
          .attr("class", "country")
          .attr("d", path)
          .attr("id", function(d,i) { return d.id; })
          .attr("title", function(d) { return d.properties.name; })
          .style("fill", function(d) {
            if (valueHash[d.properties.name]) {
                var c = quantize((valueHash[d.properties.name]));
                return getColor(c);
            } else {
                return "#ccc";
            }
          })
          // Dynamic part: mouseover to see country name and energy info
          .on("mousemove", function(d) {
            var html = "";

            html += "<div class=\"tooltip_kv\">";
            html += "<span class=\"tooltip_key\">";
            html += d.properties.name;
            html += "</span>";
            html += "<span class=\"tooltip_value\">";
            html += (valueHash[d.properties.name] ? valueHash[d.properties.name] : "");
            html += " QBTU";
            html += "</span>";
            html += "</div>";
            
            $("#tooltip-container").html(html);
            $(this).attr("fill-opacity", "0.8");
            $("#tooltip-container").show();
          
            var coordinates = d3.mouse(this);
            
            var map_width = $('.choropleth')[0].getBoundingClientRect().width;
            
            if (d3.event.pageX < map_width / 2) {
              d3.select("#tooltip-container")
                .style("top", (d3.event.layerY+50) + "px")
                .style("left", (d3.event.layerX) + "px");
            } else {
              var tooltip_width = $("#tooltip-container").width();
              d3.select("#tooltip-container")
                .style("top", (d3.event.layerY +50) + "px")
                .style("left", (d3.event.layerX - tooltip_width - 30) + "px");
            }
          })

          .on("click", function(d) {

            if(countriesSelected.length < 3) {
              countriesSelected.push(d);
            }
            else {
              countriesSelected[2] = countriesSelected[1];
              countriesSelected[1] = countriesSelected[0];
              countriesSelected[0] = d;
            }

            sliderD = draw(d, valueHash, productionValueHash);

          })

          .on("mouseout", function() {
            $(this).attr("fill-opacity", "1.0");
            $("#tooltip-container").hide();
          }); //end of country line
            
          g.append("path")
              .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
              .attr("class", "boundary")
              .attr("d", path);
          
          svg.attr("height", height * 2.2 / 3);


          /***********************
          * Map Legend
          ***********************/

          var map = d3.select("svg");
          map.append("g")
          .attr("class", "legendLinear")
          .attr("transform", "translate(5,25)");

          var legendLinear = d3.legend.color()
          .shapeWidth(30)
          .orient('horizontal')
          .scale(getColor);

          svg.select(".legendLinear").call(legendLinear);

      // svg.append("text")
      //   .attr("class", "keyLabel")
      //   .attr("x", 0)
      //   .attr("y", 20)
      //   .text("Energy Consumption in BTU")
      //   .attr("font-size", "10px");

        }); //end of json map function
          //-----------------------------------------------------------------
        function draw(objj, values, productionValueHash) {
          console.log(productionValueHash);
          d3.select("#dataZoom").remove();
          //recreate bar graph
          d3.select("#viz").append("svg").attr("id", "dataZoom").attr("width", "465").attr("height","320");
          var dataZoom = d3.select("#dataZoom");
          var dataZoomXScale = d3.scale.linear().domain([0,120]).range([0,440]);
          var xAxis = d3.svg.axis().scale(dataZoomXScale).orient("bottom").ticks(6);
          dataZoom.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(20, 295)")
          .call(xAxis);
          var topThree = getTopThree(values);
          var rectHeight = 30;
          var transitionDuration = 750;

          for(var i = 0; i < 3; i++) {

            var barWidth = topThree[i]["value"];
            var barTitle = topThree[i]["countryName"];
            
            // dataZoom.append("rect")
            // .attr("x", "0")
            // .attr("y", i*40+10)
            // .attr("height", rectHeight)
            // .attr("width", 0)
            // .attr("fill", "#8AA1B1")
            // .attr("opacity", "1")
            // .transition(transitionDuration)
            // .attr("width", dataZoomXScale(barWidth)+1);

            // dataZoom.append("rect")
            // .attr("x", "0")
            // .attr("y", i*40+10)
            // .attr("height", rectHeight)
            // .attr("width", 0)
            // .attr("fill", "#000")
            // .attr("opacity", ".2")
            // .transition(transitionDuration)
            // .attr("width", dataZoomXScale(productionValueHash[barTitle])+1);
            dataZoom.append("rect")
            .attr("x", "20")
            .attr("y", i*40+10+25+6.5)
            .attr("height", rectHeight/2)
            .attr("width", 0)
            .attr("fill", "#589CC4")
            .attr("z-fill", "1")
            .transition(transitionDuration)
            .attr("width", dataZoomXScale(barWidth)+1);

            dataZoom.append("rect")
            .attr("x", "20")
            .attr("y", i*40+24+25-15)
            .attr("height", rectHeight)
            .attr("width", 0)
            .attr("fill", "#CCC")
            .attr("opacity", ".3")
            .transition(transitionDuration)
            .attr("width", dataZoomXScale(productionValueHash[barTitle])+1);

            dataZoom.append("text").attr("x","200").attr("y", i*40+30+25).attr("fill", "#000000").text(barTitle);

          }

          for (var x = 0; x < countriesSelected.length; x++) {

            dataZoom.append("rect")
            .attr("x", "20")
            .attr("y", x*40+170+6.5)
            .attr("height", rectHeight/2)
            .attr("width", 0)
            .attr("fill", "#589CC4")
            .attr("opacity", "1")
            .transition(transitionDuration)
            .attr("width", dataZoomXScale(values[countriesSelected[x].properties.name]+1));

            dataZoom.append("rect")
            .attr("x", "20")
            .attr("y", x*40+184-15)
            .attr("height", rectHeight)
            .attr("width", 0)
            .attr("fill", "#CCC")
            .attr("opacity", ".3")
            .transition(transitionDuration)
            .attr("width", dataZoomXScale(productionValueHash[countriesSelected[x].properties.name]+1));

            dataZoom.append("text").attr("x","200").attr("y", x*40+190).attr("fill", "#000000").text(countriesSelected[x].properties.name);  

          }
          dataZoom.append("text").attr("x","180").attr("y", "340").attr("fill", "#000").text("(Quadrillion BTU)"); 


         dataZoom.append("rect")
          .attr("x", "100")
          .attr("y", 0)
          .attr("height", 18)
          .attr("fill", "#589CC4")
          .attr("opacity", "1")
          .attr("width", 40);

          dataZoom.append("rect")
          .attr("x", "250")
          .attr("y", 0)
          .attr("height", 18)
          .attr("fill", "#CCC")
          .attr("opacity", ".3")
          .attr("width", 40);

          // Styling of the datazoom graph
          dataZoom.append("text")
          .attr("x","-145").attr("y", "15")
          .attr("transform", "rotate(-90)")
          .style("color", "#000").text("Top 3 Countries"); 

          dataZoom.append("text")
          .attr("x","-275").attr("y", "15")
          .attr("transform", "rotate(-90)")
          .style("color", "#000").text("User Selected"); 

          dataZoom.append("line")
          .attr("x1", "20")
          .attr("y1", "157.5")
          .attr("x2", "440")
          .attr("y2", "157.5")
          .style("stroke", "#000000")
          .style("stroke-width", "2px")
          .style("stroke-dasharray", "5, 5");

          dataZoom.append("text").attr("x","145").attr("y", "12.5").attr("fill", "#000000").text("Consumption"); 
          dataZoom.append("text").attr("x","295").attr("y", "12.5").attr("fill", "#000000").text("Production"); 

          // Energy consumed (in million btu) per person
          // var popValue = values[objj.properties.name]/popHash[objj.properties.name] * 1000;
          // dataZoom.append("text").attr("x","10").attr("y","350")
          //   .attr("fill", "#00000")
          //   .attr("font-size", "20px")
          //   .text("Every person in " + objj.properties.name + " spends/consumes " + Math.round(popValue) + " million btu of energy");

          return objj;
        }
        d3.select(self.frameElement).style("height", (height * 2.3 / 3) + "px");
      
        /***********************
        * Slider
        ***********************/
        rval = "1993";

        d3.select("#slider2").on("input", function() {
          var rval = (this).value;
          $("#sliderNum").html(rval);
          refillMap("consumption.csv", ""+rval, sliderD);
          loadChords(rval);
                    
        });


        function refillMap(file, input, clickedCountry) {
          var map = d3.select("#canvas-svg");
          // Consumption csv
          d3.csv(file, function(err, data) {

            // Production csv
            d3.csv('production.csv', function(err, producData) {
              var configProd = {"country":"Country", "score":input};

              var country_key = configProd.country;
              var score_value = configProd.score;

              productionValueHash = {};
              producData.forEach(function(d) {
                productionValueHash[d[country_key]] = +d[score_value];
              });
              var config = {"country":"Country", "score":input};
              var country_key = config.country;
              var score_value = config.score;
              valueHash = {};
                data.forEach(function(d) {
                valueHash[d[country_key]] = +d[score_value];
              });

              if (allowBarGraphToChange) {
                draw(clickedCountry, valueHash, productionValueHash);
                loadChords(input);
              }

              map.selectAll(".country").data(countries)
                .transition(750)
                .style("fill", function(d) {
                if (valueHash[d.properties.name]) {
                  var c = quantize((valueHash[d.properties.name]));
                  return getColor(c);
                } else {
                        return "#ccc";
                }
                
              }); //end of consumption csv

            }); //end of production csv

          }); 

        } //end of refill

        var shouldPlay = true;
        $("#play").click(function() {

          if(shouldPlay) {
            shouldPlay = false;
             //if value < max
            $("#slider2").val(1993);  
            $("#slider2").trigger('change');
            var i = 0, howManyTimes = 21;
            function f() {

                allowBarGraphToChange = false    

                $("#slider2").val(1993+i);  
                $("#slider2").trigger('change');
                rval = $("#slider2").val();

                $("#sliderNum").html(rval);
                refillMap("consumption.csv", ""+rval, sliderD);
                i++;

                if( i < howManyTimes ){
                    setTimeout( f, 500 );
                }
                else {

                  allowBarGraphToChange = true;  
                  shouldPlay = true;

                }
            }
            f();

          }
        });


      }); //end of population csv

    }); //end of countries csv

  }); //end of production csv

} //end of toggle map

// Default on Consumption
var innerDiv = document.createElement('div');
innerDiv.id = 'sliderNum';
innerDiv.innerHTML = $("#slider2").val();

// The variable iDiv is still good... Just append to it.

ToggleMap("consumption.csv", "1993");

// Toggles between the multiple graphs



//Sort the values so that we can display the top three
function sortobj(obj) {
  var keys=Object.keys(obj);
  var kva= keys.map(function(k,i) {
      return [k,obj[k]];
  });
  kva.sort(function(a,b){
      if(a[1]>b[1]) return -1;if(a[1]<b[1]) return 1;
      return 0
  });
  var o={}
  kva.forEach(function(a){ o[a[0]]=a[1]})
  return o;
}

  //get the top three co
function getTopThree(arrayToSort) {

  arrayToSort = sortobj(arrayToSort); 
  var x = 0;
  var topThree = [];
  for (var countryName in arrayToSort) {
    if(x < 3) {
      var countryToPush = {};
      countryToPush.countryName = countryName;
      countryToPush.value = arrayToSort[countryName];
      topThree.push(countryToPush);

    }
     x++;
  }
  return topThree;

}

/***********************
* Chord Graph
***********************/
// var cmargin = {left: 50, top: 10, right: 50, bottom: 10};
var cwidth = 410;
var cheight = 333; // 5/6

var csvg = d3.select('#chordG').append('svg')
  .attr("width", cwidth)
  .attr("height", cheight) // does not rely on margins

var outerRadius = cheight / 2 - 100;
var innerRadius = outerRadius * 0.95;
var opacityDef = 0.7;

var labels = ["Coal", "Electricity", "Natural Gas","Petroleum", "", "China", "USA", "Russia", "Other", ""];

var wrapper = csvg.append("g").attr("class", "chordWrapper")
  .attr("transform", "translate(" + (cwidth / 2 ) + "," + (cheight / 2 ) + ") scale(2.0)" );


// d3.text("Production/1993.csv", "text/csv", function(err,data) {
var offset;
d3.text("Consumption/1993.csv", "text/csv", function(err,data) { 
  matrix = d3.csv.parseRows(data);
  for (var i = 0; i < matrix.length; i++) {
    for (var j = 0; j < matrix.length; j++) {
      matrix[i][j] = parseFloat(matrix[i][j]);
    }
  }
  var emptyStroke = parseFloat(matrix[9][4]);

  // Rotation for vertical invisible chord
  offset = Math.PI * (emptyStroke/(emptyStroke / .4)) / 2;

  var chord = d3.layout.chord()
    .padding(.08)
    .sortSubgroups(d3.descending)
    .sortChords(d3.descending)
    .matrix(matrix)

  var arc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(outerRadius)
    .startAngle(startAngle)
    .endAngle(endAngle);

  var path = d3.svg.chord()
    .radius(innerRadius)
    .startAngle(startAngle)
    .endAngle(endAngle);

  var fill = d3.scale.ordinal()
    .domain(d3.range(labels.length))
    .range(["#C4C4C4","#C4C4C4","#C4C4C4", "#C4C4C4","#E0E0E0","#EDC951","#CC333F","#00A0B0", "#7D1D3F", "#E0E0E0"]) //change later

  /* Outer Arcs */ 
  var g = wrapper.selectAll("g.group")
    .data(chord.groups)
    .enter().append("g")
    .attr("class", "group");
  g.append("path")
    .style("stroke", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
    .style("fill", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
    .attr("d", arc)
    .on("mouseover", fade(.1))
    .on("mouseout", fade(.7));


  /* Append Names */ 
  g.append("text")
      .each(function(d) { d.angle = ((d.startAngle + d.endAngle) / 2) + offset;}) //Slightly altered function to define the angle
      .attr("dy", "0em")
      .attr("class", "titles")
      .attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
      .attr("transform", function(d,i) { 
        var c = arc.centroid(d);
        return "rotate(" + (d.angle * 180 / Math.PI - 102) + ")"
        + "translate(" + (innerRadius + 10) + ")"
        + (d.angle > Math.PI ? "rotate(180)" : "")
      })
      .on("mouseover", fade(.1))
      .on("mouseout", fade(.7))
      .text(function(d,i) { return labels[i]; });

  /* Inner Chords */ 
  var chords = wrapper.selectAll("path.chord")
    .data(chord.chords)
    .enter().append("path")
    .attr("class", "chord")
    .style("stroke", "none")
    .style("fill", function(d,i) { 
      return fill(d.target.index); 
    })
    .style("opacity", function(d) {
      if (labels[d.source.index] === "") return 0;
      else return opacityDef;
    })
    .attr("d", path);

  })

function startAngle(d) { return d.startAngle + .7 * offset; }
function endAngle(d) { return d.endAngle + .7 * offset; }
function fade(opac) {
  return function(g, i) { // i is the specific cord/source
    csvg.selectAll("path.chord")
      .filter(function(d) {
        return d.source.index != i && d.target.index != i; 
      })
      .transition(750)
        .style("opacity", function(d) {
          if (labels[d.source.index] === "") return 0;
          else return opac;
        })
  }
}

function loadChords(input) {
  var chord = d3.select("#chordG");
  var matrix;
  // Get array of arrays- all values are STRINGS
  d3.text("Consumption/" + String(input) + ".csv", "text/csv", function(err,data) {  
    matrix = d3.csv.parseRows(data);

    // Convert from string to int
    for (var i = 0; i < matrix.length; i++) {
      for (var j = 0; j < matrix.length; j++) {
        matrix[i][j] = parseFloat(matrix[i][j]);
      }
    }
    var emptyStroke = matrix[9][4];

    // Rotation for vertical invisible chord
    var offset = Math.PI * (emptyStroke/(emptyStroke / .4)) / 2;

    chord = d3.layout.chord()
      .padding(.08)
      .sortSubgroups(d3.descending)
      .sortChords(d3.descending)
      .matrix(matrix)

    arc = d3.svg.arc()
      .innerRadius(innerRadius)
      .outerRadius(outerRadius)
      .startAngle(startAngle)
      .endAngle(endAngle);

    path = d3.svg.chord()
      .radius(innerRadius)
      .startAngle(startAngle)
      .endAngle(endAngle);
    var fill = d3.scale.ordinal()
      .domain(d3.range(labels.length))
      .range(["#C4C4C4","#C4C4C4","#C4C4C4", "#C4C4C4","#E0E0E0","#EDC951","#CC333F","#00A0B0", "#7D1D3F", "#E0E0E0"])

    /* Outer Arcs */ 
    g = wrapper.selectAll("g.group")
      .data(chord.groups);
      // .attr("class", "group");
    g.select("path")
      .style("stroke", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
      .style("fill", function(d, i) {
      if (labels[i] === "") return "none";
      else return fill(d.index);
    })
      .attr("d", arc)
      .on("mouseover", fade(.1))
      .on("mouseout", fade(.7));
    /* Update Names */ 

    g.select("text")
      .transition(750)
      .each(function(d) { d.angle = ((d.startAngle + d.endAngle) / 2) + offset;}) //Slightly altered function to define the angle
      .attr("dy", "0em")
      .attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
      .attr("transform", function(d,i) { 
        var c = arc.centroid(d);
        return "rotate(" + (d.angle * 180 / Math.PI - 102) + ")"
        + "translate(" + (innerRadius + 10) + ")"
        + (d.angle > Math.PI ? "rotate(180)" : "")
      });
      // .text(function(d,i) { return labels[i]; });

    /* Inner Chords */ 
    chords = wrapper.selectAll("path.chord")
      .data(chord.chords)
      // .attr("class", "chord")
      .style("stroke", "none")
      .style("fill", function(d,i) { 
        return fill(d.target.index);
      })
      .style("opacity", function(d) {
      if (labels[d.source.index] === "") return 0;
      else return opacityDef;
    })
      .attr("d", path);
  })
}

/* PRODUCTION: FIX ON BUTTON TOGGLE */
// function loadChords(input) {
//   var chord = d3.select("#chordG");
//   var matrix;
//   // Get array of arrays- all values are STRINGS
//   d3.text("Production/" + String(input) + ".csv", "text/csv", function(err,data) {  
//     matrix = d3.csv.parseRows(data);

//     // Convert from string to int
//     for (var i = 0; i < matrix.length; i++) {
//       for (var j = 0; j < matrix.length; j++) {
//         matrix[i][j] = parseInt(matrix[i][j]);
//       }
//     }
//     var emptyStroke = matrix[9][4];

//     // Rotation for vertical invisible chord
//     var offset = Math.PI * (emptyStroke/(emptyStroke / .4)) / 2;

//     chord = d3.layout.chord()
//       .padding(.08)
//       .sortSubgroups(d3.descending)
//       .sortChords(d3.descending)
//       .matrix(matrix)

//     arc = d3.svg.arc()
//       .innerRadius(innerRadius)
//       .outerRadius(outerRadius)
//       .startAngle(startAngle)
//       .endAngle(endAngle);

//     path = d3.svg.chord()
//       .radius(innerRadius)
//       .startAngle(startAngle)
//       .endAngle(endAngle);
//     var fill = d3.scale.ordinal()
//       .domain(d3.range(labels.length))
//       .range(["#C4C4C4","#C4C4C4","#C4C4C4", "#C4C4C4","#E0E0E0","#EDC951","#CC333F","#00A0B0", "#7D1D3F", "#E0E0E0"])

//     /* Outer Arcs */ 
//     g = wrapper.selectAll("g.group")
//       .data(chord.groups);
//       // .attr("class", "group");
//     g.select("path")
//       .style("stroke", function(d, i) {
//       if (labels[i] === "") return "none";
//       else return fill(d.index);
//     })
//       .style("fill", function(d, i) {
//       if (labels[i] === "") return "none";
//       else return fill(d.index);
//     })
//       .attr("d", arc)
//       .on("mouseover", fade(.1))
//       .on("mouseout", fade(.7));
//     /* Update Names */ 

//     g.select("text")
//       .transition(750)
//       .each(function(d) { d.angle = ((d.startAngle + d.endAngle) / 2) + offset;}) //Slightly altered function to define the angle
//       .attr("dy", "0em")
//       .attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
//       .attr("transform", function(d,i) { 
//         var c = arc.centroid(d);
//         return "rotate(" + (d.angle * 180 / Math.PI - 102) + ")"
//         + "translate(" + (innerRadius + 10) + ")"
//         + (d.angle > Math.PI ? "rotate(180)" : "")
//       });
//       // .text(function(d,i) { return labels[i]; });

//     /* Inner Chords */ 
//     chords = wrapper.selectAll("path.chord")
//       .data(chord.chords)
//       // .attr("class", "chord")
//       .style("stroke", "none")
//       .style("fill", function(d,i) { 
//         return fill(d.target.index);
//       })
//       .style("opacity", function(d) {
//       if (labels[d.source.index] === "") return 0;
//       else return opacityDef;
//     })
//       .attr("d", path);
//   })
// }

</script>

</body>
</html>