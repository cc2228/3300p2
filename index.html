<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
<!-- Stylesheets -->
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/d3.slider.css" />

<!-- Fonts -->
<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="js/d3.slider.js"></script>

<head>

<!-- TODO
Update tooltips
Update when clicking to different 
 -->

<body>

  <h2>World Energy Measurements</h2>

  <div id ="buttons">
    <button id="toggleCons">Energy Consumption</button> | <button id="toggleProd">Energy Production</button>
  </div>

  <input id="slider2" class = "slider" type="range" min="1993" max="2013" value = "1993" step="1" />

  <div id="tooltip-container"></div>

  <div id = "viz">
    <div id="canvas-svg">
      <div id = "sliderNum">1993</div>
    </div>
    <div id="dataZoom"></div>
  </div>

<script>

//slider

// Color scale
var getColor = d3.scale.linear().domain([0,100]).range(["#d6f5d6","#145214"]);
var valueHash, quantize, countries;
var sliderD = "China";

function ToggleMap(file, input) {

  d3.csv(file, function(err, data) {

    var config = {"country":"Country", "score":input};

    var width = 720, height = 720;

    var country_key = config.country;
    var score_value = config.score;

    // d3 projection of world map
    var projection = d3.geo.mercator().scale((width + 1) / 2 / Math.PI).translate([width / 2, height / 2]).precision(.1);

    var path = d3.geo.path().projection(projection);

    var graticule = d3.geo.graticule();

    var svg = d3.select("#canvas-svg").append("svg")
      .attr("width", width)
      .attr("height", height);

    svg.append("path").datum(graticule).attr("class", "graticule").attr("d", path);

      // Create hashmap with country and value
    valueHash = {};
    data.forEach(function(d) {
      valueHash[d[country_key]] = +d[score_value];
    });



    // hashmap for population data
    var popHash = {};

    // Import data for population, create hash value that can later be used to compare with consumption/prod
    d3.csv("population.csv", function(err, popData) {
      // Lillyan: Can you make the slider work for this part too? This is the population
      var configPop = {"country":"Country", "score": "1993"};

      var country_key_pop = configPop.country;
      var score_value_pop = configPop.score;
      popData.forEach(function(d) {
          popHash[d[country_key_pop]] = +d[score_value_pop];
      });

      quantize = d3.scale.quantize().domain([0, 1.0]).range(d3.range(100).map(function(i) { return i; }));

      quantize.domain([d3.min(data, function(d){
        return (+d[score_value]) }),
      d3.max(data, function(d){
        return (+d[score_value]) })]);

      // Source: Vida world json file
      d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/world-topo-min.json", function(error, world) {
        countries = topojson.feature(world, world.objects.countries).features;

        //initialize bar graph
        sliderD = countries[41];
        draw(sliderD, valueHash);
        svg.append("path")
           .datum(graticule)
           .attr("class", "choropleth")
           .attr("d", path);

        var g = svg.append("g");

        g.append("path")
         .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
         .attr("class", "equator")
         .attr("d", path);

        d3.select("#slider").on("input", function() {
          console.log("heloo");
        }); 

        var country = g.selectAll(".country").data(countries);

        ////------------------------------------------------------------------
        country.enter().insert("path")
        .attr("class", "country")
        .attr("d", path)
        .attr("id", function(d,i) { return d.id; })
        .attr("title", function(d) { return d.properties.name; })
        .style("fill", function(d) {
          if (valueHash[d.properties.name]) {
              var c = quantize((valueHash[d.properties.name]));
              return getColor(c);
          } else {
              return "#ccc";
          }
        })

        // Dynamic part: mouseover to see country name and energy info
        .on("mousemove", function(d) {
          var html = "";

          html += "<div class=\"tooltip_kv\">";
          html += "<span class=\"tooltip_key\">";
          html += d.properties.name;
          html += "</span>";
          html += "<span class=\"tooltip_value\">";
          html += (valueHash[d.properties.name] ? valueHash[d.properties.name] : "");
          html += "";
          html += "</span>";
          html += "</div>";
          
          $("#tooltip-container").html(html);
          $(this).attr("fill-opacity", "0.8");
          $("#tooltip-container").show();
          
          var coordinates = d3.mouse(this);
          
          var map_width = $('.choropleth')[0].getBoundingClientRect().width;
          
          if (d3.event.pageX < map_width / 2) {
            d3.select("#tooltip-container")
              .style("top", (d3.event.layerY + 15) + "px")
              .style("left", (d3.event.layerX + 15) + "px");
          } else {
            var tooltip_width = $("#tooltip-container").width();
            d3.select("#tooltip-container")
              .style("top", (d3.event.layerY + 15) + "px")
              .style("left", (d3.event.layerX - tooltip_width - 30) + "px");
          }
        })

        .on("click", function(d) {

          sliderD = draw(d, valueHash);

        })

        .on("mouseout", function() {
          $(this).attr("fill-opacity", "1.0");
          $("#tooltip-container").hide();
        }); //end of country line
          
        g.append("path")
            .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
            .attr("class", "boundary")
            .attr("d", path);
        
        svg.attr("height", height * 2.2 / 3);

      }); //end of json map function
        //-----------------------------------------------------------------
      function draw(objj, values) {

        d3.select("#dataZoom").remove();

        //recreate bar graph
        d3.select("#viz").append("svg").attr("id", "dataZoom").attr("width", "440").attr("height","320");
        var dataZoom = d3.select("#dataZoom");

        var dataZoomXScale = d3.scale.linear().domain([0,120]).range([0,440]);
        var xAxis = d3.svg.axis().scale(dataZoomXScale).orient("bottom").ticks(6);
        dataZoom.append("g").attr("class", "axis").attr("transform", "translate(0, 200)").call(xAxis);

        var topThree = getTopThree(values);

        var rectHeight = 30;
        var transitionDuration = 750;

        for(var i = 0; i < 4; i++) {

          var barWidth = values[objj.properties.name];
          var barTitle = objj.properties.name;
          if(i < 3) {

            barWidth = topThree[i]["value"];
            barTitle = topThree[i]["countryName"];
          }
          dataZoom.append("rect")
          .attr("x", "10")
          .attr("y", i*40+10)
          .attr("height", rectHeight)
          .attr("width", 0)
          .transition(transitionDuration)
          .attr("width", dataZoomXScale(barWidth));

          dataZoom.append("text").attr("x","20").attr("y", i*40+30).attr("fill", "#fff").text(barTitle);

        }
        

        // Energy consumed (in million btu) per person
        var popValue = values[objj.properties.name]/popHash[objj.properties.name] * 1000;
        dataZoom.append("text").attr("x","20").attr("y","250")
          .attr("fill", "#00000")
          .attr("font-size", "20px")
          .text("Every person in " + objj.properties.name + " spends/consumes " + Math.round(popValue) + " million btu of energy");

        return objj;

      }

      d3.select(self.frameElement).style("height", (height * 2.3 / 3) + "px");
      /***********************
      * Slider
      ***********************/

      d3.select("#slider2").on("input", function() {
          var rval = (this).value;
          $("#sliderNum").html(rval);
         if ($('#toggleCons').hasClass("active")) {
            refillMap("consumption.csv", ""+rval, sliderD);
          }
          else if ($('#toggleProd').hasClass("active")) {
            refillMap("production.csv", ""+rval, sliderD);
          }          
      });


      function refillMap(file, input, clickedCountry) {
        var map = d3.select("#canvas-svg");
        d3.csv(file, function(err, data) {
          var config = {"country":"Country", "score":input};
          var country_key = config.country;
          var score_value = config.score;
          valueHash = {};
            data.forEach(function(d) {
            valueHash[d[country_key]] = +d[score_value];
          });

            draw(clickedCountry, valueHash);

          map.selectAll(".country").data(countries)
            .transition(750)
            .style("fill", function(d) {
            if (valueHash[d.properties.name]) {
              var c = quantize((valueHash[d.properties.name]));
                // console.log(getColor(c));
              return getColor(c);
                // return "#ccc";
            } else {
                    return "#ccc";
            }
          });

        }); 
      } //end of refill

    }); //end of population csv

  }); //end of countries csv

} //end of toggle map

// Default on Consumption
ToggleMap("consumption.csv", "2013");
document.getElementById('toggleCons').style.fontWeight = "bold";
$("#toggleCons").addClass("active");

// Toggles between the multiple graphs
$("#toggleCons").on('click', function() {
  //document.getElementById('toggleEPI').style.fontWeight = "normal";
  document.getElementById('toggleProd').style.fontWeight = "normal";
  $("#canvas-svg").empty();

  $(this).siblings().removeClass('active');
  $(this).addClass('active');

  document.getElementById('toggleCons').style.fontWeight = "bold";
  ToggleMap("consumption.csv", "2013");
});


$("#toggleProd").on('click', function() {
  //document.getElementById('toggleEPI').style.fontWeight = "normal";
  document.getElementById('toggleCons').style.fontWeight = "normal";
  $("#canvas-svg").empty();

  $(this).siblings().removeClass('active');
  $(this).addClass('active');

  document.getElementById('toggleProd').style.fontWeight = "bold";
  ToggleMap("production.csv", "2013");
});



//Sort the values so that we can display the top three
function sortobj(obj) {
  var keys=Object.keys(obj);
  var kva= keys.map(function(k,i) {
      return [k,obj[k]];
  });
  kva.sort(function(a,b){
      if(a[1]>b[1]) return -1;if(a[1]<b[1]) return 1;
      return 0
  });
  var o={}
  kva.forEach(function(a){ o[a[0]]=a[1]})
  return o;
}

  //get the top three co
function getTopThree(arrayToSort) {

  arrayToSort = sortobj(arrayToSort); 
  var x = 0;
  var topThree = [];
  for (var countryName in arrayToSort) {
    if(x < 3) {
      var countryToPush = {};
      countryToPush.countryName = countryName;
      countryToPush.value = arrayToSort[countryName];
      topThree.push(countryToPush);

    }
     x++;
  }
  return topThree;

}


</script>

</body>
</html>