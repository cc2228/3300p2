<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
<!-- Stylesheets -->
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="css/d3.slider.css" />

<!-- Fonts -->
<link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="js/d3.slider.js"></script>
<head>

<body>

  <h2>World Energy Measurements</h2>

  <div id ="buttons">
    <button id="toggleEPI">EPI</button> | <button id="toggleCons">Energy Consumption</button> | <button id="toggleProd">Energy Production</button>
  </div>

  <div id="tooltip-container"></div>
  <div id = "viz">
    <div id="canvas-svg"></div>
    <div id="canvas-svg"></div>
    <div id="slider"></div>
    <div id="dataZoom"></div>
  </div>
<script>
// Color scale
var getColor = d3.scale.linear().domain([0,100]).range(["#d6f5d6","#145214"]);
var valueHash, quantize, countries;

function ToggleMap(file, input) {

  d3.csv(file, function(err, data) {

  var config = {"country":"Country", "score":input};

  var width = 720, height = 720;

  var country_key = config.country;
  var score_value = config.score;

  // d3 projection of world map
  var projection = d3.geo.mercator()
    .scale((width + 1) / 2 / Math.PI)
    .translate([width / 2, height / 2])
    .precision(.1);

  var path = d3.geo.path()
    .projection(projection);

  var graticule = d3.geo.graticule();

  var svg = d3.select("#canvas-svg").append("svg")
    .attr("width", width)
    .attr("height", height);

  svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

// Create hashmap with country and value
  valueHash = {};
    data.forEach(function(d) {
    valueHash[d[country_key]] = +d[score_value];
  });
    console.log(valueHash);

  quantize = d3.scale.quantize()
    .domain([0, 1.0])
    .range(d3.range(100).map(function(i) { return i; }));

  quantize.domain([d3.min(data, function(d){
    return (+d[score_value]) }),
  d3.max(data, function(d){
    return (+d[score_value]) })]);

  // Source: Vida world json file
  d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/world-topo-min.json", function(error, world) {
  countries = topojson.feature(world, world.objects.countries).features;

  svg.append("path")
     .datum(graticule)
     .attr("class", "choropleth")
     .attr("d", path);

  var g = svg.append("g");

  g.append("path")
   .datum({type: "LineString", coordinates: [[-180, 0], [-90, 0], [0, 0], [90, 0], [180, 0]]})
   .attr("class", "equator")
   .attr("d", path);

  var country = g.selectAll(".country").data(countries);


      country.enter().insert("path")
      .attr("class", "country")
      .attr("d", path)
      .attr("id", function(d,i) { return d.id; })
      .attr("title", function(d) { return d.properties.name; })
      .style("fill", function(d) {
        if (valueHash[d.properties.name]) {
            var c = quantize((valueHash[d.properties.name]));
            return getColor(c);
        } else {
            return "#ccc";
        }
      })

    // Dynamic part: mouseover to see country name and energy info
    .on("mousemove", function(d) {
      var html = "";

      html += "<div class=\"tooltip_kv\">";
      html += "<span class=\"tooltip_key\">";
      html += d.properties.name;
      html += "</span>";
      html += "<span class=\"tooltip_value\">";
      html += (valueHash[d.properties.name] ? valueHash[d.properties.name] : "");
      html += "";
      html += "</span>";
      html += "</div>";
      
      $("#tooltip-container").html(html);
      $(this).attr("fill-opacity", "0.8");
      $("#tooltip-container").show();
      
      var coordinates = d3.mouse(this);
      
      var map_width = $('.choropleth')[0].getBoundingClientRect().width;
      
      if (d3.event.pageX < map_width / 2) {
        d3.select("#tooltip-container")
          .style("top", (d3.event.layerY + 15) + "px")
          .style("left", (d3.event.layerX + 15) + "px");
      } else {
        var tooltip_width = $("#tooltip-container").width();
        d3.select("#tooltip-container")
          .style("top", (d3.event.layerY + 15) + "px")
          .style("left", (d3.event.layerX - tooltip_width - 30) + "px");
      }




    })



  .on("click", function(d) {
    d3.select("#dataZoom").remove();
    d3.select("#viz").append("svg").attr("id", "dataZoom").attr("width", "440").attr("height","320");
    var dataZoom = d3.select("#dataZoom");



  //var dataZoomXScale = d3.scale.log()
      // .base(Math.E)
      // .domain([Math.exp(0), Math.exp(9)])
      // .range([0, 440]);

    var dataZoomXScale = d3.scale.linear().domain([0,120]).range([0,440]);
    var xAxis = d3.svg.axis().scale(dataZoomXScale).orient("bottom").ticks(6);
    dataZoom.append("g").attr("class", "axis").attr("transform", "translate(0, 200)").call(xAxis);

      var rectHeight = 30;
      dataZoom.append("rect")
      .transition()
    .attr("x", "10")
    .attr("y", "10")
    .attr("height", rectHeight)
    .attr("width", dataZoomXScale(valueHash["China"]));
      
        dataZoom.append("rect")
        .transition()
        .delay(250)
    .attr("x", "10")
    .attr("y", "50")
    .attr("height", rectHeight)
    .attr("width", dataZoomXScale(valueHash["United States"]));
       
        dataZoom.append("rect")
        .transition()
        .delay(500)
    .attr("x", "10")
    .attr("y", "90")
    .attr("height", rectHeight)
    .attr("width", dataZoomXScale(valueHash["Russian Federation"]));
    
    dataZoom.append("rect")
    .transition()
    .delay(750)
    .attr("x", "10")
    .attr("y", "130")
    .attr("height",rectHeight)
    .attr("width", dataZoomXScale(valueHash[d.properties.name]));


    dataZoom.append("text").attr("x","20").attr("y","30").attr("fill", "#fff").text("China");
    dataZoom.append("text").attr("x","20").attr("y","70").attr("fill", "#fff").text("United States");
    dataZoom.append("text").attr("x","20").attr("y","110").attr("fill", "#fff").text("Russian Federation");
    dataZoom.append("text").attr("x","20").attr("y","150").attr("fill", "#fff").text(d.properties.name);
  })
  .on("mouseout", function() {
            $(this).attr("fill-opacity", "1.0");
            $("#tooltip-container").hide();
        });
    
  g.append("path")
      .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
      .attr("class", "boundary")
      .attr("d", path);
  
  svg.attr("height", height * 2.2 / 3);
  });
  
  d3.select(self.frameElement).style("height", (height * 2.3 / 3) + "px");
  

// Circle graphs
/* var svgContainer = d3.select("#circle-graph").append("svg")
  .attr("width", 200)
  .attr("height", 200);
 
 countries.forEach(function(d) {
  console.log("hi");
  svgContainer.append("circle")
    .attr("cx", 100)
    .attr("cy", 100)
    .attr("r", function(d) { 
      console.log(valueHash[countries]);
    });

 })*/

  });
//  d3.select("#slider").call(d3.slider().axis(true).min(1993).max(2013).step(1).on("slide", function(evt, value) {
//   var time = value;

// }));
}

// Default on EPI
ToggleMap("epi.csv", "Score");
document.getElementById('toggleEPI').style.fontWeight = "bold";

// Toggles between the multiple graphs
// EPI only has data avaliable for 2013
$("#toggleEPI").on('click', function() {
  document.getElementById('toggleCons').style.fontWeight = "normal";
  document.getElementById('toggleProd').style.fontWeight = "normal";
  $("#canvas-svg").empty();

  document.getElementById('toggleEPI').style.fontWeight = "bold";
  ToggleMap("epi.csv", "Score");
});

$("#toggleCons").on('click', function() {
  document.getElementById('toggleEPI').style.fontWeight = "normal";
  document.getElementById('toggleProd').style.fontWeight = "normal";
  $("#canvas-svg").empty();

  $(this).siblings().removeClass('active');
  $(this).addClass('active');

  document.getElementById('toggleCons').style.fontWeight = "bold";
  ToggleMap("consumption.csv", "2013");
});


$("#toggleProd").on('click', function() {
  document.getElementById('toggleEPI').style.fontWeight = "normal";
  document.getElementById('toggleCons').style.fontWeight = "normal";
  $("#canvas-svg").empty();

  $(this).siblings().removeClass('active');
  $(this).addClass('active');

  document.getElementById('toggleProd').style.fontWeight = "bold";
  ToggleMap("production.csv", "2013");
});

function refillMap(file, input) {
  var map = d3.select("#canvas-svg");
  d3.csv(file, function(err, data) {
    var config = {"country":"Country", "score":input};
    var country_key = config.country;
    var score_value = config.score;
    valueHash = {};
      data.forEach(function(d) {
      valueHash[d[country_key]] = +d[score_value];
    });

    map.selectAll(".country").data(countries)
      .transition(750)
      .style("fill", function(d) {
        if (valueHash[d.properties.name]) {
            var c = quantize((valueHash[d.properties.name]));
            // console.log(getColor(c));
            return getColor(c);
            // return "#ccc";
        } else {
                return "#ccc";
            }
    })
    // .on("mousemove", function(d) {
    //   var html = "";

    //   html += "<div class=\"tooltip_kv\">";
    //   html += "<span class=\"tooltip_key\">";
    //   html += d.properties.name;
    //   html += "</span>";
    //   html += "<span class=\"tooltip_value\">";
    //   html += (valueHash[d.properties.name] ? valueHash[d.properties.name] : "");
    //   html += "";
    //   html += "</span>";
    //   html += "</div>";
      
    //   $("#tooltip-container").html(html);
    //   $(this).attr("fill-opacity", "0.8");
    //   $("#tooltip-container").show();
    // })

  });

}

/***********************
* Slider
***********************/
var yearList = ["1993", "1994", "1995", "1996", "1997", "1998","1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013"];

 d3.select("#slider").call(d3.slider().axis(true).min(1993).max(2013).step(1).value(2013).on("slide", function(evt, value) {
  var time = value;
  if ($('#toggleCons').hasClass("active")) {
    refillMap("consumption.csv", String(time));
  }
  else if ($('#toggleProd').hasClass("active")) {
    refillMap("production.csv", String(time));
  }
}));

</script>

</body>
</html>